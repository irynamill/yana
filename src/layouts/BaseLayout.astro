---
import "@/styles/global.css";
import BaseHead from "@/components/fundations/head/BaseHead.astro";
// sections
import Footer from "@/components/global/Footer.astro";
import Navigation from "@/components/global/Navigation.astro";

const lang = Astro.url.searchParams.get("lang") ?? "en";
const translations = {
  en: {
    cookieText:
      "We use cookies to improve your experience and enable third-party content. You can accept or decline.",
    accept: "Accept",
    decline: "Decline",
  },
  de: {
    cookieText:
      "Wir verwenden Cookies, um Ihr Erlebnis zu verbessern und Drittinhalte zu laden. Sie können zustimmen oder ablehnen.",
    accept: "Akzeptieren",
    decline: "Ablehnen",
  },
  ru: {
    cookieText:
      "Мы используем cookies для улучшения работы сайта и загрузки стороннего контента. Вы можете принять или отклонить.",
    accept: "Принять",
    decline: "Отклонить",
  },
  uk: {
    cookieText:
      "Ми використовуємо cookies для покращення роботи сайту та завантаження стороннього контенту. Ви можете прийняти або відхилити.",
    accept: "Прийняти",
    decline: "Відхилити",
  },
};
const t = translations[lang] ?? translations.en;
---

<html lang="en" class="scroll-smooth">
  <head>
    <BaseHead />
  </head>
  <body class="bg-white dark:bg-base-950 flex flex-col h-svh">
    <Navigation />
    <main class="grow"><slot /></main>
    <Footer />
    <div
      class="fixed bottom-4 left-4 right-4 z-50 rounded-2xl border border-base-200 bg-white/95 p-4 text-sm text-base-700 shadow-sm backdrop-blur dark:border-base-800 dark:bg-base-950/95 dark:text-base-200 lg:left-auto lg:right-4 lg:max-w-md"
      data-cookie-banner
      hidden
    >
      <div class="flex flex-col gap-3">
        <p>{t.cookieText}</p>
        <div class="flex gap-3">
          <button
            class="rounded-2xl border border-base-300 px-4 py-2 text-xs font-semibold uppercase tracking-[2px] text-base-900 transition-colors hover:border-base-900 dark:border-base-700 dark:text-white dark:hover:border-base-300"
            data-cookie-accept
            type="button"
          >
            {t.accept}
          </button>
          <button
            class="rounded-2xl border border-base-300 px-4 py-2 text-xs font-semibold uppercase tracking-[2px] text-base-900 transition-colors hover:border-base-900 dark:border-base-700 dark:text-white dark:hover:border-base-300"
            data-cookie-decline
            type="button"
          >
            {t.decline}
          </button>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  const banner = document.querySelector("[data-cookie-banner]");
  const accept = document.querySelector("[data-cookie-accept]");
  const decline = document.querySelector("[data-cookie-decline]");
  const key = "cookie-consent";

  const applyConsent = (value) => {
    if (value) localStorage.setItem(key, value);
    if (banner) banner.hidden = true;

    document.querySelectorAll("[data-consent-embed]").forEach((container) => {
      if (value === "accepted") {
        if (!container.querySelector("iframe")) {
          const src = container.getAttribute("data-embed-src");
          const iframe = document.createElement("iframe");
          iframe.title = "Embedded content";
          iframe.className = "h-72 w-full";
          iframe.src = src;
          iframe.loading = "lazy";
          container.innerHTML = "";
          container.appendChild(iframe);
        }
      }
    });
  };

  const existing = localStorage.getItem(key);
  if (!existing && banner) banner.hidden = false;
  if (existing === "accepted") applyConsent("accepted");

  accept?.addEventListener("click", () => applyConsent("accepted"));
  decline?.addEventListener("click", () => applyConsent("declined"));

  document.querySelectorAll("[data-consent-open]").forEach((button) => {
    button.addEventListener("click", () => {
      if (banner) banner.hidden = false;
    });
  });
</script>
